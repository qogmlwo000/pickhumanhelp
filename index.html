<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë² ë„· ì§‘í’ˆ ì¸ì› íš¨ìœ¨ ê³„ì‚°ê¸° - Ver 1.0 (ì‹¤ì‹œê°„ ì—°ë™)</title>
    
    <link rel="icon" href="https://raw.githubusercontent.com/qogmlwo000/gwj2pickpackhtp/main/Bennett.ico" type="image/x-icon">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; scrollbar-width: thin; scrollbar-color: #4a5568 #2d3748; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 4px; }
        .app-container { display: flex; height: 100vh; }
        #sidebar { width: 300px; transition: margin-left 0.3s ease-in-out, transform 0.3s ease-in-out; position: fixed; top: 0; left: 0; height: 100%; z-index: 40; transform: translateX(-100%); }
        #sidebar.open { transform: translateX(0); }
        #main-content { transition: margin-left 0.3s ease-in-out; width: 100%; }
        @media (min-width: 1024px) {
            #sidebar { position: static; transform: translateX(0); }
            #main-content { flex: 1; min-width: 0; }
            .app-container.sidebar-collapsed #sidebar { margin-left: -300px; }
            #sidebar-toggle-desktop { display: block; }
            #sidebar-toggle-mobile { display: none; }
        }
        @media (max-width: 1023px) {
            #sidebar-toggle-desktop { display: none; }
            #sidebar-toggle-mobile { display: block; }
        }
        #main-title { animation: color-cycle 10s infinite linear; }
        @keyframes color-cycle {
            0%   { color: #FF0000; } 14%  { color: #FF7F00; } 28%  { color: #FFFF00; }
            42%  { color: #00FF00; } 57%  { color: #0000FF; } 71%  { color: #4B0082; }
            85%  { color: #9400D3; } 100% { color: #FF0000; }
        }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .is-typing-indicator {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            font-size: 0.65rem; font-style: italic; color: #f59e0b;
            animation: blink 1.5s infinite;
            pointer-events: none;
        }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

<div id="app-container" class="app-container">
    <aside id="sidebar" class="bg-gray-800 p-4 flex-shrink-0 flex flex-col space-y-4 overflow-y-auto">
        <h2 class="text-xl font-bold text-white border-b border-gray-700 pb-2">ğŸ“‹ ì •ë³´</h2>
        <div class="bg-gray-700 p-3 rounded-lg text-sm text-gray-300 space-y-2">
            <p class="font-bold text-lg text-green-400">âš¡ ì‹¤ì‹œê°„ í˜‘ì—… ëª¨ë“œ</p>
            <p>ì´ í˜ì´ì§€ì— ì ‘ì†í•œ ëª¨ë“  ì‚¬ìš©ìì™€ ë°ì´í„°ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤.</p>
            <p class="mt-2 font-semibold text-amber-400">â­ ìš°ì„ ìˆœìœ„ ê¸°ëŠ¥ ì¶”ê°€</p>
            <p>ê° ì¸µì˜ ì‘ì—… ìš°ì„ ìˆœìœ„ë¥¼ ì„¤ì •í•˜ë©´, 'ê¸´ê¸‰'í•œ ì¸µì— ë¨¼ì € ì¸ì›ì„ ì§€ì›í•˜ë„ë¡ ì œì•ˆí•©ë‹ˆë‹¤.</p>
        </div>
    </aside>
    
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

    <main id="main-content" class="flex-1 flex flex-col">
        <div class="w-full bg-gray-800 shadow-lg p-4 flex-shrink-0">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <button id="sidebar-toggle-desktop" class="p-2 rounded-md hover:bg-gray-700 mr-4"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
                    <button id="sidebar-toggle-mobile" class="p-2 rounded-md hover:bg-gray-700 mr-4"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
                    <div>
                        <h1 id="main-title" class="text-2xl font-extrabold">ğŸš€ ë² ë„· ì§‘í’ˆ ì¸ì› íš¨ìœ¨ ê³„ì‚°ê¸° - Ver 1.0</h1>
                        <p class="text-gray-400 text-sm">ëª¨ë“  ë³€ê²½ì‚¬í•­ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ìë™ ë™ê¸°í™”ë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="capture-area" class="p-4 md:p-6 flex flex-col flex-grow overflow-y-auto bg-gray-900 space-y-6">
            <div class="bg-gray-800 rounded-lg p-5">
                <h2 class="text-lg font-bold text-white mb-4">âš™ï¸ ì „ì²´ ì œì–´íŒ</h2>
                <div class="space-y-4">
                    <div class="relative">
                        <label class="block mb-2 text-sm font-medium text-gray-300">ë§ˆê°ê¹Œì§€ ë‚¨ì€ ì‹œê°„</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="deadline-hours" class="calc-input w-full bg-gray-700 border-gray-600 rounded-md p-2 text-base" placeholder="0">
                            <span class="font-semibold text-gray-400">ì‹œê°„</span>
                            <input type="number" id="deadline-minutes" class="calc-input w-full bg-gray-700 border-gray-600 rounded-md p-2 text-base" placeholder="0">
                            <span class="font-semibold text-gray-400">ë¶„</span>
                        </div>
                    </div>
                    <div class="border-t border-gray-700 pt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button id="share-btn" class="w-full cursor-pointer py-2 px-4 rounded-lg text-sm font-semibold bg-teal-600 text-white hover:bg-teal-700 flex items-center justify-center space-x-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg><span>ê²°ê³¼ ìº¡ì²˜/ê³µìœ </span></button>
                        <button id="reset-btn" class="w-full cursor-pointer py-2 px-4 rounded-lg text-sm font-semibold bg-red-600 text-white hover:bg-red-700 flex items-center justify-center space-x-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg><span>ì „ì²´ ì´ˆê¸°í™”</span></button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-4 gap-6">
                <div class="calculator-card bg-gray-800 rounded-lg flex flex-col overflow-hidden border-t-4 border-yellow-400">
                    <div class="p-5 space-y-4">
                        <h2 class="text-xl font-bold text-yellow-400">ğŸ¢ 6ì¸µ (6.1 + 6.3)</h2>
                        <div class="relative">
                            <label class="text-sm font-medium text-gray-400">â­ ì‘ì—… ìš°ì„ ìˆœìœ„</label>
                            <select id="priority-6f" class="calc-input w-full bg-gray-700 rounded p-2 mt-1 appearance-none">
                                <option value="ê¸´ê¸‰">ğŸš¨ê¸´ê¸‰</option>
                                <option value="ë³´í†µ" selected>ë³´í†µ</option>
                                <option value="ì—¬ìœ ">ğŸ‘ì—¬ìœ </option>
                            </select>
                        </div>
                        <div class="space-y-3">
                            <div class="relative"><label class="text-sm font-medium text-gray-400">í˜„ì¬ ì¸ì› (ëª…)</label><input type="number" id="staff-6f" class="calc-input w-full bg-gray-700 rounded p-2 mt-1" placeholder="0"></div>
                            <div class="relative"><label class="text-sm font-medium text-gray-400">ì§‘í’ˆ ë°±ë¡œê·¸ (ìœ ë‹› ìˆ˜)</label><input type="number" id="backlog-6f" class="calc-input w-full bg-gray-700 rounded p-2 mt-1" placeholder="0"></div>
                        </div>
                        <div class="bg-gray-700/60 p-3 rounded-md space-y-2">
                            <div class="flex justify-between items-center"><label class="text-sm font-semibold text-cyan-400">ì§„í–‰ ìƒí™©</label><button id="apply-progress-6f" class="apply-progress-btn text-xs bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-1 px-2 rounded">ğŸ”„ ë°˜ì˜</button></div>
                            <div class="flex items-center space-x-2">
                                <div class="w-full relative"><input type="number" id="progress-minutes-6f" class="calc-input w-full bg-gray-600 p-1.5 rounded" placeholder="0"><span class="text-sm text-gray-400 absolute right-2 top-1/2 -translate-y-1/2">ë¶„</span></div>
                                <div class="w-full relative"><input type="number" id="progress-units-6f" class="calc-input w-full bg-gray-600 p-1.5 rounded" placeholder="0"><span class="text-sm text-gray-400 absolute right-2 top-1/2 -translate-y-1/2">ê°œ</span></div>
                            </div>
                        </div>
                        <div class="relative"><label class="text-sm font-medium text-gray-400">ì¸ë‹¹ UPH</label><input type="number" id="uph-6f" class="calc-input w-full bg-gray-700 rounded p-2 mt-1" placeholder="ìë™ ê³„ì‚°"></div>
                    </div>
                    <div class="border-t border-gray-700 mt-auto p-5 space-y-2 text-sm bg-gray-800/50">
                        <p class="flex justify-between"><span>ğŸ“ˆ ì˜ˆìƒ ì™„ë£Œ ì‹œê°„:</span> <span id="result-completion-time-6f" class="font-bold text-lg text-white">-.--</span></p>
                        <p class="flex justify-between"><span>ğŸ¯ ëª©í‘œ ë‹¬ì„± UPH:</span> <span id="result-required-uph-6f" class="font-bold text-lg text-white">-.--</span></p>
                        <p class="flex justify-between"><span>ğŸ§‘â€ğŸ¤â€ğŸ§‘ í•„ìš”/ì‰ì—¬ ì¸ì›:</span> <span id="result-staff-diff-6f" class="font-bold text-lg text-white">-.--</span></p>
                    </div>
                </div>
                <div class="calculator-card bg-gray-800 rounded-lg flex flex-col overflow-hidden border-t-4 border-green-400">
                     <div class="p-5 space-y-4">
                        <h2 class="text-xl font-bold text-green-400">ğŸ¢ 7.2ì¸µ</h2>
                        <div class="relative"><label class="text-sm font-medium text-gray-400">â­ ì‘ì—… ìš°ì„ ìˆœìœ„</label><select id="priority-72f" class="calc-input w-full bg-gray-700 rounded p-2 mt-1 appearance-none"><option value="ê¸´ê¸‰">ğŸš¨ê¸´ê¸‰</option><option value="ë³´í†µ" selected>ë³´í†µ</option><option value="ì—¬ìœ ">ğŸ‘ì—¬ìœ </option></select></div>
                        <div class="space-y-3">
                            <div class="relative"><label class="text-sm font-medium text-gray-400">í˜„ì¬ ì¸ì› (ëª…)</label><input type="number" id="staff-72f" class="calc-input w-full bg-gray-700 rounded p-2 mt-1" placeholder="0"></div>
                            <div class="relative"><label class="text-sm font-medium text-gray-400">ì§‘í’ˆ ë°±ë¡œê·¸ (ìœ ë‹› ìˆ˜)</label><input type="number" id="backlog-72f" class="calc-input w-full bg-gray-700 rounded p-2 mt-1" placeholder="0"></div>
                        </div>
                        <div class="bg-gray-700/60 p-3 rounded-md space-y-2">
                             <div class="flex justify-between items-center"><label class="text-sm font-semibold text-cyan-400">ì§„í–‰ ìƒí™©</label><button id="apply-progress-72f" class="apply-progress-btn text-xs bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-1 px-2 rounded">ğŸ”„ ë°˜ì˜</button></div>
                            <div class="flex items-center space-x-2">
                                <div class="w-full relative"><input type="number" id="progress-minutes-72f" class="calc-input w-full bg-gray-600 p-1.5 rounded" placeholder="0"><span class="text-sm text-gray-400 absolute right-2 top-1/2 -translate-y-1/2">ë¶„</span></div>
                                <div class="w-full relative"><input type="number" id="progress-units-72f" class="calc-input w-full bg-gray-600 p-1.5 rounded" placeholder="0"><span class="text-sm text-gray-400 absolute right-2 top-1/2 -translate-y-1/2">ê°œ</span></div>
                            </div>
                        </div>
                        <div class="relative"><label class="text-sm font-medium text-gray-400">ì¸ë‹¹ UPH</label><input type="number" id="uph-72f" class="calc-input w-full bg-gray-700 rounded p-2 mt-1" placeholder="ìë™ ê³„ì‚°"></div>
                    </div>
                    <div class="border-t border-gray-700 mt-auto p-5 space-y-2 text-sm bg-gray-800/50">
                        <p class="flex justify-between"><span>ğŸ“ˆ ì˜ˆìƒ ì™„ë£Œ ì‹œê°„:</span> <span id="result-completion-time-72f" class="font-bold text-lg text-white">-.--</span></p>
                        <p class="flex justify-between"><span>ğŸ¯ ëª©í‘œ ë‹¬ì„± UPH:</span> <span id="result-required-uph-72f" class="font-bold text-lg text-white">-.--</span></p>
                        <p class="flex justify-between"><span>ğŸ§‘â€ğŸ¤â€ğŸ§‘ í•„ìš”/ì‰ì—¬ ì¸ì›:</span> <span id="result-staff-diff-72f" class="font-bold text-lg text-white">-.--</span></p>
                    </div>
                </div>
                <div class="calculator-card bg-gray-800 rounded-lg flex flex-col overflow-hidden border-t-4 border-blue-400">
                    <div class="p-5 space-y-4">
                        <h2 class="text-xl font-bold text-blue-400">ğŸ¢ 7.3ì¸µ</h2>
                        <div class="relative"><label class="text-sm font-medium text-gray-400">â­ ì‘ì—… ìš°ì„ ìˆœìœ„</label><select id="priority-73f" class="calc-input w-full bg-gray-700 rounded p-2 mt-1 appearance-none"><option value="ê¸´ê¸‰">ğŸš¨ê¸´ê¸‰</option><option value="ë³´í†µ" selected>ë³´í†µ</option><option value="ì—¬ìœ ">ğŸ‘ì—¬ìœ </option></select></div>
                        <div class="space-y-3">
                            <div class="relative"><label class="text-sm font-medium text-gray-400">í˜„ì¬ ì¸ì› (ëª…)</label><input type="number" id="staff-73f" class="calc-input w-full bg-gray-700 rounded p-2 mt-1" placeholder="0"></div>
                            <div class="relative"><label class="text-sm font-medium text-gray-400">ì§‘í’ˆ ë°±ë¡œê·¸ (ìœ ë‹› ìˆ˜)</label><input type="number" id="backlog-73f" class="calc-input w-full bg-gray-700 rounded p-2 mt-1" placeholder="0"></div>
                        </div>
                        <div class="bg-gray-700/60 p-3 rounded-md space-y-2">
                             <div class="flex justify-between items-center"><label class="text-sm font-semibold text-cyan-400">ì§„í–‰ ìƒí™©</label><button id="apply-progress-73f" class="apply-progress-btn text-xs bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-1 px-2 rounded">ğŸ”„ ë°˜ì˜</button></div>
                            <div class="flex items-center space-x-2">
                                <div class="w-full relative"><input type="number" id="progress-minutes-73f" class="calc-input w-full bg-gray-600 p-1.5 rounded" placeholder="0"><span class="text-sm text-gray-400 absolute right-2 top-1/2 -translate-y-1/2">ë¶„</span></div>
                                <div class="w-full relative"><input type="number" id="progress-units-73f" class="calc-input w-full bg-gray-600 p-1.5 rounded" placeholder="0"><span class="text-sm text-gray-400 absolute right-2 top-1/2 -translate-y-1/2">ê°œ</span></div>
                            </div>
                        </div>
                        <div class="relative"><label class="text-sm font-medium text-gray-400">ì¸ë‹¹ UPH</label><input type="number" id="uph-73f" class="calc-input w-full bg-gray-700 rounded p-2 mt-1" placeholder="ìë™ ê³„ì‚°"></div>
                    </div>
                    <div class="border-t border-gray-700 mt-auto p-5 space-y-2 text-sm bg-gray-800/50">
                        <p class="flex justify-between"><span>ğŸ“ˆ ì˜ˆìƒ ì™„ë£Œ ì‹œê°„:</span> <span id="result-completion-time-73f" class="font-bold text-lg text-white">-.--</span></p>
                        <p class="flex justify-between"><span>ğŸ¯ ëª©í‘œ ë‹¬ì„± UPH:</span> <span id="result-required-uph-73f" class="font-bold text-lg text-white">-.--</span></p>
                        <p class="flex justify-between"><span>ğŸ§‘â€ğŸ¤â€ğŸ§‘ í•„ìš”/ì‰ì—¬ ì¸ì›:</span> <span id="result-staff-diff-73f" class="font-bold text-lg text-white">-.--</span></p>
                    </div>
                </div>
                <div class="bg-gray-900 border-2 border-dashed border-teal-500 rounded-lg p-5 flex flex-col">
                    <h2 class="text-xl font-bold text-teal-400 mb-4">ğŸ“Š ì „ì²´ í˜„í™© ìš”ì•½</h2>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-x-4"><span class="text-gray-400">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ì´ ì¸ì›:</span><span id="total-staff" class="font-bold text-white text-lg text-right">0 ëª…</span></div>
                        <div class="grid grid-cols-2 gap-x-4"><span class="text-gray-400">ğŸ“¦ ì´ ë°±ë¡œê·¸:</span><span id="total-backlog" class="font-bold text-white text-lg text-right">0 ìœ ë‹›</span></div>
                        <div class="grid grid-cols-2 gap-x-4"><span class="text-gray-400">âš¡ ì´ ì‹œê°„ë‹¹ ì²˜ë¦¬ëŸ‰:</span><span id="total-throughput" class="font-bold text-white text-lg text-right">0 ìœ ë‹›/ì‹œê°„</span></div>
                        <div class="border-t border-gray-700 pt-3"></div>
                        <div class="grid grid-cols-2 gap-x-4"><span class="text-gray-400">ğŸ“ˆ ì „ì²´ ì˜ˆìƒ ì™„ë£Œ:</span><span id="total-completion-time" class="font-bold text-white text-lg text-right">-.--</span></div>
                        <div class="grid grid-cols-2 gap-x-4"><span class="text-gray-400">ğŸ§‘â€ğŸ¤â€ğŸ§‘ ì „ì²´ í•„ìš”/ì‰ì—¬:</span><span id="total-staff-diff" class="font-bold text-white text-lg text-right">-.--</span></div>
                    </div>
                    <div class="border-t border-dashed border-gray-700 mt-4 pt-4">
                         <h3 class="text-lg font-bold text-amber-400 mb-2 text-center">ğŸ’¡ ìµœì  ì¸ì› ì¬ë°°ì¹˜ ì œì•ˆ</h3>
                        <div id="recommendation-area" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
// âœ¨ YOUR FIREBASE CONFIG: 1ë‹¨ê³„ì—ì„œ ë³µì‚¬í•œ ì½”ë“œë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
const firebaseConfig = {
  apiKey: "AIzaSyC1iUAOPtVFy2XcxU7x8qjUwZjmB8VOdpc",
  authDomain: "logistics-calculator-fb355.firebaseapp.com",
  databaseURL: "https://logistics-calculator-fb355-default-rtdb.firebaseio.com",
  projectId: "logistics-calculator-fb355",
  storageBucket: "logistics-calculator-fb355.firebasestorage.app",
  messagingSenderId: "14994462026",
  appId: "1:14994462026:web:4f9507241c1cf29d569db3",
  measurementId: "G-TF51GP65HR"
};

// --- ì´í•˜ ì½”ë“œëŠ” ìˆ˜ì •í•  í•„ìš” ì—†ìŠµë‹ˆë‹¤. ---

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

document.addEventListener('DOMContentLoaded', () => {
    const ui = {
        appContainer: document.getElementById('app-container'),
        sidebar: document.getElementById('sidebar'),
        sidebarToggleDesktop: document.getElementById('sidebar-toggle-desktop'),
        sidebarToggleMobile: document.getElementById('sidebar-toggle-mobile'),
        sidebarOverlay: document.getElementById('sidebar-overlay'),
        resetBtn: document.getElementById('reset-btn'),
        shareBtn: document.getElementById('share-btn'),
        captureArea: document.getElementById('capture-area'),
        recommendationArea: document.getElementById('recommendation-area'),
    };

    const floors = [ { id: '6f', name: '6ì¸µ' }, { id: '72f', name: '7.2ì¸µ' }, { id: '73f', name: '7.3ì¸µ' }];
    let floorStats = {};
    let localTypingTimeout = null;
    let isUpdatingFromFirebase = false;

    const toggleMobileSidebar = () => { ui.sidebar.classList.toggle('open'); ui.sidebarOverlay.classList.toggle('hidden', !ui.sidebar.classList.contains('open')); };
    const toggleDesktopSidebar = () => ui.appContainer.classList.toggle('sidebar-collapsed');

    ui.sidebarToggleMobile.addEventListener('click', toggleMobileSidebar);
    ui.sidebarToggleDesktop.addEventListener('click', toggleDesktopSidebar);
    ui.sidebarOverlay.addEventListener('click', toggleMobileSidebar);
    
    db.ref().on('value', (snapshot) => {
        isUpdatingFromFirebase = true;
        const data = snapshot.val();
        if (data) {
            updateUIFromFirebase(data);
            calculateAll();
            updateTypingIndicators(data.typing || {});
        }
        setTimeout(() => { isUpdatingFromFirebase = false; }, 100);
    });
    
    function handleInputChange(event) {
        const path = event.target.id.replace(/-/g, '/');
        const value = event.target.type === 'number' ? (parseFloat(event.target.value) || 0) : event.target.value;
        db.ref(path).set(value);
        db.ref(`typing/${path}`).set(null);
    }
    
    function handleTyping(event) {
        if (isUpdatingFromFirebase) return;
        const path = event.target.id.replace(/-/g, '/');
        db.ref(`typing/${path}`).set(true);
        clearTimeout(localTypingTimeout);
        localTypingTimeout = setTimeout(() => db.ref(`typing/${path}`).set(null), 800);
    }

    function updateUIFromFirebase(data) {
        document.querySelectorAll('.calc-input').forEach(input => {
            const path = input.id.replace(/-/g, '/');
            const value = getObjectValueByPath(data, path);
            if (value !== undefined && document.activeElement !== input) {
                 input.value = value || (input.type === 'number' ? '' : 'ë³´í†µ');
            }
        });
    }
    
    function updateTypingIndicators(typingData) {
        document.querySelectorAll('.is-typing-indicator').forEach(ind => ind.remove());
        for (const path in typingData) {
            if (typingData[path]) {
                const id = path.replace(/\//g, '-');
                const input = document.getElementById(id);
                if (input && input.parentElement.classList.contains('relative')) {
                    const indicator = document.createElement('span');
                    indicator.className = 'is-typing-indicator';
                    indicator.textContent = 'ì…ë ¥ ì¤‘...';
                    input.parentElement.appendChild(indicator);
                }
            }
        }
    }

    function formatTime(hours) {
        if (!isFinite(hours) || hours <= 0) return "-.--";
        const h = Math.floor(hours);
        const m = Math.round((hours - h) * 60);
        return `${h > 0 ? h + 'ì‹œê°„ ' : ''}${m > 0 ? m + 'ë¶„' : ''}`.trim() || "0ë¶„";
    }

    function generateRecommendation() {
        let surplusFloors = [];
        let deficitFloors = [];
        const priorityOrder = { 'ê¸´ê¸‰': 1, 'ë³´í†µ': 2, 'ì—¬ìœ ': 3 };

        floors.forEach(floor => {
            const stat = floorStats[floor.id];
            if (!stat) return;
            const floorData = { ...floor, ...stat };

            if (stat.staffDiff > 0) surplusFloors.push({ ...floorData, surplus: stat.staffDiff });
            else if (stat.staffDiff < 0) deficitFloors.push({ ...floorData, deficit: Math.abs(stat.staffDiff) });
        });

        surplusFloors.sort((a, b) => b.surplus - a.surplus);
        deficitFloors.sort((a, b) => {
            const priorityA = priorityOrder[a.priority] || 2;
            const priorityB = priorityOrder[b.priority] || 2;
            if (priorityA !== priorityB) return priorityA - priorityB;
            return b.deficit - a.deficit;
        });

        ui.recommendationArea.innerHTML = '';
        if (deficitFloors.length === 0) {
            ui.recommendationArea.innerHTML = '<p class="text-center text-green-400">âœ… í˜„ì¬ ì¸ì› ë°°ì¹˜ê°€ ì•ˆì •ì ì…ë‹ˆë‹¤.</p>';
            return;
        }
        if (surplusFloors.length === 0) {
            ui.recommendationArea.innerHTML = '<p class="text-center text-red-400">âš ï¸ ëª¨ë“  ì¸µì˜ ì¸ì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.</p>';
            return;
        }

        let recommendations = [];
        for (let needy of deficitFloors) {
            if (needy.deficit <= 0) continue;
            let needed = needy.deficit;
            for (let donor of surplusFloors) {
                if (donor.surplus <= 0 || needed <= 0) continue;
                const moveCount = Math.min(needed, donor.surplus);
                const needyNewTime = (needy.backlog / ((needy.staff + moveCount) * needy.uph));
                const donorNewTime = (donor.staff - moveCount > 0) ? (donor.backlog / ((donor.staff - moveCount) * donor.uph)) : Infinity;
                recommendations.push({ donorName: donor.name, needyName: needy.name, moveCount, needyOriginalTime: needy.completionTime, needyNewTime, donorOriginalTime: donor.completionTime, donorNewTime });
                needed -= moveCount;
                donor.surplus -= moveCount;
            }
        }
        
        if (recommendations.length > 0) {
            recommendations.forEach(rec => {
                const recHTML = `
                    <div class="bg-gray-800 p-3 rounded-lg">
                        <p class="font-bold text-center text-lg">${rec.donorName} â¡ï¸ ${rec.needyName}ìœ¼ë¡œ ${rec.moveCount}ëª… ì§€ì›</p>
                        <div class="text-xs text-gray-400 mt-2 space-y-1">
                            <p>âˆ™ <span class="font-semibold">${rec.needyName}:</span> ${formatTime(rec.needyOriginalTime)} â†’ <span class="text-green-400 font-bold">${formatTime(rec.needyNewTime)}</span></p>
                            <p>âˆ™ <span class="font-semibold">${rec.donorName}:</span> ${formatTime(rec.donorOriginalTime)} â†’ <span class="text-yellow-400 font-bold">${formatTime(rec.donorNewTime)}</span></p>
                        </div>
                    </div>`;
                ui.recommendationArea.innerHTML += recHTML;
            });
        } else {
             ui.recommendationArea.innerHTML = '<p class="text-center text-green-400">âœ… í˜„ì¬ ì¸ì› ë°°ì¹˜ê°€ ì•ˆì •ì ì…ë‹ˆë‹¤.</p>';
        }
    }

    function calculateAll() {
        const deadlineHours = parseFloat(document.getElementById('deadline-hours').value) || 0;
        const deadlineMinutes = parseFloat(document.getElementById('deadline-minutes').value) || 0;
        const deadline = deadlineHours + (deadlineMinutes / 60);

        let total = { staff: 0, backlog: 0, throughput: 0 };
        floorStats = {};

        floors.forEach(floor => {
            const floorId = floor.id;
            const staff = parseFloat(document.getElementById(`staff-${floorId}`).value) || 0;
            const backlog = parseFloat(document.getElementById(`backlog-${floorId}`).value) || 0;
            const uphInput = document.getElementById(`uph-${floorId}`);
            const progressMinutes = parseFloat(document.getElementById(`progress-minutes-${floorId}`).value) || 0;
            const progressUnits = parseFloat(document.getElementById(`progress-units-${floorId}`).value) || 0;
            const priority = document.getElementById(`priority-${floorId}`).value || 'ë³´í†µ';

            if (progressMinutes > 0 && progressUnits > 0 && staff > 0) {
                const calculatedUPH = (progressUnits / staff) / (progressMinutes / 60);
                if (document.activeElement !== uphInput) { uphInput.value = calculatedUPH.toFixed(1); }
            }
            
            const uph = parseFloat(uphInput.value) || 0;
            const floorThroughput = staff * uph;
            const completionTime = (floorThroughput > 0) ? (backlog / floorThroughput) : 0;
            const completionTimeEl = document.getElementById(`result-completion-time-${floorId}`);
            
            completionTimeEl.classList.remove('text-red-500');
            completionTimeEl.textContent = formatTime(completionTime);

            if (deadline > 0 && completionTime > deadline) {
                completionTimeEl.classList.add('text-red-500');
                completionTimeEl.innerHTML = `ğŸš¨ ${completionTimeEl.textContent}`;
            }

            let staffDiff = 0;
            if (deadline > 0 && backlog > 0) {
                const requiredStaff = (uph > 0) ? Math.ceil((backlog / deadline) / uph) : 0;
                staffDiff = staff - requiredStaff;
                document.getElementById(`result-staff-diff-${floorId}`).innerHTML = staffDiff >= 0 ? `<span class="text-green-400">+${staffDiff}ëª… (ì‰ì—¬)</span>` : `<span class="text-red-400">${staffDiff}ëª… (ë¶€ì¡±)</span>`;
            } else {
                 document.getElementById(`result-staff-diff-${floorId}`).textContent = "-.--";
            }
            
            document.getElementById(`result-required-uph-${floorId}`).textContent = (deadline > 0 && staff > 0) ? `${(backlog / (staff * deadline)).toFixed(1)} UPH` : "-.--";
            
            floorStats[floorId] = { staff, backlog, uph, staffDiff, completionTime, priority };

            total.staff += staff;
            total.backlog += backlog;
            total.throughput += floorThroughput;
        });

        document.getElementById('total-staff').textContent = `${total.staff} ëª…`;
        document.getElementById('total-backlog').textContent = `${total.backlog.toLocaleString()} ìœ ë‹›`;
        document.getElementById('total-throughput').textContent = `${total.throughput.toLocaleString()} ìœ ë‹›/ì‹œê°„`;
        
        const totalCompletionTime = (total.throughput > 0) ? (total.backlog / total.throughput) : 0;
        const totalCompletionTimeEl = document.getElementById('total-completion-time');
        totalCompletionTimeEl.classList.remove('text-red-500');
        totalCompletionTimeEl.textContent = formatTime(totalCompletionTime);
        if(deadline > 0 && totalCompletionTime > deadline) {
            totalCompletionTimeEl.classList.add('text-red-500');
            totalCompletionTimeEl.innerHTML = `ğŸš¨ ${totalCompletionTimeEl.textContent}`;
        }

        if (deadline > 0 && total.backlog > 0) {
            const avgUPH = (total.staff > 0) ? (total.throughput / total.staff) : 0;
            const totalRequiredStaff = (avgUPH > 0) ? Math.ceil((total.backlog / deadline) / avgUPH) : 0;
            const totalStaffDiff = total.staff - totalRequiredStaff;
            document.getElementById('total-staff-diff').innerHTML = totalStaffDiff >= 0 ? `<span class="text-green-400">+${totalStaffDiff}ëª… (ì‰ì—¬)</span>` : `<span class="text-red-400">${totalStaffDiff}ëª… (ë¶€ì¡±)</span>`;
        } else {
            document.getElementById('total-staff-diff').textContent = "-.--";
        }

        generateRecommendation();
    }
    
    document.querySelectorAll('.calc-input').forEach(input => {
        input.addEventListener('change', handleInputChange);
        input.addEventListener('input', handleTyping);
    });
    
    document.querySelectorAll('.apply-progress-btn').forEach(button => {
        button.addEventListener('click', () => {
            const floorId = button.id.replace('apply-progress-', '');
            const paths = { backlog: `backlog/${floorId}`, progressUnits: `progress-units/${floorId}`, progressMinutes: `progress-minutes/${floorId}` };
            db.ref().once('value', (snapshot) => {
                const data = snapshot.val();
                const currentBacklog = getObjectValueByPath(data, paths.backlog) || 0;
                const processedUnits = getObjectValueByPath(data, paths.progressUnits) || 0;
                if (processedUnits > 0) {
                    let updates = {};
                    updates[paths.backlog] = Math.max(0, currentBacklog - processedUnits);
                    updates[paths.progressUnits] = null;
                    updates[paths.progressMinutes] = null;
                    db.ref().update(updates);
                }
            });
        });
    });

    ui.resetBtn.addEventListener('click', () => {
        if(confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? Firebaseì— ì—°ê²°ëœ ëª¨ë“  ì‚¬ìš©ìì˜ ë°ì´í„°ê°€ ì§€ì›Œì§‘ë‹ˆë‹¤.')) {
            db.ref().set(null);
        }
    });

    ui.shareBtn.addEventListener('click', async () => {
        showModal('ì´ë¯¸ì§€ ìƒì„± ì¤‘...', 'success', 1500);
        try {
            const canvas = await html2canvas(ui.captureArea, { backgroundColor: '#111827', useCORS: true, scale: 1.5 });
            canvas.toBlob(async (blob) => {
                await navigator.clipboard.write([ new ClipboardItem({ 'image/png': blob }) ]);
                showModal('ê²°ê³¼ê°€ ì´ë¯¸ì§€ë¡œ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success', 3000);
            }, 'image/png');
        } catch (err) {
            console.error('ì´ë¯¸ì§€ ìº¡ì²˜ ì‹¤íŒ¨:', err);
            showModal('ì´ë¯¸ì§€ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error', 3000);
        }
    });

    function showModal(message, type = 'success', duration = 3000) {
        const modal = document.createElement('div');
        modal.className = `fixed top-5 right-5 ${type === 'success' ? 'bg-blue-500' : 'bg-red-400'} text-white py-2 px-4 rounded-lg shadow-lg z-50 animate-fade-in-out`;
        modal.textContent = message;
        const styleId = 'modal-animation-style';
        if (!document.getElementById(styleId)) {
            const style = document.createElement('style');
            style.id = styleId;
            style.textContent = `@keyframes fade-in-out { 0% { opacity: 0; transform: translateY(-20px); } 10% { opacity: 1; transform: translateY(0); } 90% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-20px); } } .animate-fade-in-out { animation: fade-in-out ${duration / 1000}s ease-in-out forwards; }`;
            document.head.appendChild(style);
        }
        document.body.appendChild(modal);
        setTimeout(() => modal.remove(), duration);
    }

    function getObjectValueByPath(obj, path) {
        if (!obj || !path) return undefined;
        return path.split('/').reduce((acc, part) => acc && acc[part], obj);
    }
});
</script>
</body>
</html>